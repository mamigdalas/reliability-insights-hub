<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Incident & Learning Lab - Reliability Insights Hub</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { padding-top: 20px; background-color: #f8f9fa; }
        .container { background-color: #ffffff; padding: 30px; border-radius: 8px; box-shadow: 0 0 15px rgba(0,0,0,0.1); }
        h1, h2, h3, h4 { color: #0056b3; }
        .results-section { margin-top: 30px; border-top: 1px solid #eee; padding-top: 20px; }
        .table thead th { background-color: #e9ecef; }
        .alert-info, .alert-warning, .alert-danger { font-weight: bold; }
        .alert-info { color: #0c5460; background-color: #d1ecf1; border-color: #bee5eb; }
        .alert-warning { color: #856404; background-color: #fff3cd; border-color: #ffeeba; }
        .alert-danger { color: #721c24; background-color: #f8d7da; border-color: #f5c6cb; }
        .chart-container { margin-top: 20px; }
        .sidebar {
            background-color: #343a40; /* Dark background for sidebar */
            color: #ffffff;
            height: 100vh;
            padding-top: 20px;
            position: fixed; /* Fix sidebar position */
            left: 0;
            top: 0;
            width: 250px; /* Adjust width as needed */
        }
        .sidebar .nav-link {
            color: #ffffff;
            padding: 10px 15px;
        }
        .sidebar .nav-link.active, .sidebar .nav-link:hover {
            background-color: #0056b3; /* Highlight color */
            color: #ffffff;
            border-radius: 5px;
        }
        .main-content {
            margin-left: 270px; /* Offset for fixed sidebar */
            padding: 20px;
        }
    </style>
</head>
<body>
    <div class="sidebar">
    <h3 class="text-center mb-4">Reliability Insights Hub</h3>
    <ul class="nav flex-column">
        <li class="nav-item">
            <a class="nav-link {% if active_page == 'incidents' %}active{% endif %}" href="/">Incident & Learning Lab</a>
        </li>
        <li class="nav-item">
            <a class="nav-link {% if active_page == 'benchmarking' %}active{% endif %}" href="/benchmarking">Performance Benchmarker</a>
        </li>
        <li class="nav-item">
            <a class="nav-link {% if active_page == 'routines' %}active{% endif %}" href="/routines">Routine Dynamics Explorer</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" href="/risk_navigator">Risk Strategy Navigator</a>
        </li>
    </ul>
</div>

    <div class="main-content">
        <div class="container">
            <h1 class="text-center mb-4">Incident & Learning Lab</h1>
            <p class="text-center lead">Explore how to systematically analyze incidents and near-misses, and derive actionable insights.</p>

            <div class="row">
                <div class="col-md-6">
                    <h2>Submit Incident Report</h2>
                    <form method="POST" action="/">
                        <div class="form-group">
                            <label for="incidentDescription">Incident/Near-Miss Description:</label>
                            <textarea class="form-control" id="incidentDescription" name="incident_description" rows="5" required placeholder="e.g., Operator failed to follow procedure for lockout/tagout, leading to unexpected equipment startup. Minor injury sustained.">{{ request.form.incident_description if request.form.incident_description else '' }}</textarea>
                        </div>
                        <button type="submit" class="btn btn-primary btn-block">Analyze & Add Incident</button>
                    </form>
                </div>
                <div class="col-md-6">
                    <h2>Manage Reports</h2>
                    <form method="POST" action="/load_examples">
                        <button type="submit" class="btn btn-info btn-block mb-3">Load Example Incidents</button>
                    </form>
                     <form method="POST" action="/clear_incidents" onsubmit="return confirm('Are you sure you want to clear all incidents?');">
                        <button type="submit" class="btn btn-danger btn-block">Clear All Incidents</button>
                    </form>
                    {% if incidents %}
                    <h5 class="mt-3">Current Incidents ({{ incidents|length }} total)</h5>
                    <ul class="list-group" style="max-height: 200px; overflow-y: auto;">
                        {% for incident in incidents %}
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            {{ incident.Description[:60] }}...
                            <span class="badge {{ 'badge-danger' if incident.Severity == 'High' else ('badge-warning' if incident.Severity == 'Medium' else 'badge-success') }} badge-pill">{{ incident.Severity }}</span>
                        </li>
                        {% endfor %}
                    </ul>
                    {% else %}
                    <p class="text-muted mt-3">No incidents loaded yet. Load examples or submit your own!</p>
                    {% endif %}
                </div>
            </div>

            {% if analysis_results %}
            <div class="results-section">
                <h2 class="text-center">Detailed Analysis</h2>

                <div class="table-responsive mb-4">
                    <table class="table table-bordered table-striped">
                        <thead class="thead-dark">
                            <tr>
                                <th>ID</th>
                                <th>Description</th>
                                <th>Severity</th>
                                <th>Inferred Categories</th>
                                <th>Suggested Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for result in analysis_results %}
                            <tr class="{{ 'table-danger' if result.Severity == 'High' else ('table-warning' if result.Severity == 'Medium' else '') }}">
                                <td>{{ result.Report_ID }}</td>
                                <td>{{ result.Description }}</td>
                                <td><span class="badge {{ 'badge-danger' if result.Severity == 'High' else ('badge-warning' if result.Severity == 'Medium' else 'badge-success') }} badge-pill">{{ result.Severity }}</span></td>
                                <td>{{ result.Inferred_Categories }}</td>
                                <td>{{ result.Suggested_Action }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <h3 class="text-center mt-4 mb-3">Summary Charts</h3>
                <div class="row">
                    <div class="col-md-6 chart-container">
                        <h4 class="text-center">Incidents by Severity</h4>
                        <div id="severityChart" style="height: 300px;"></div>
                    </div>
                    <div class="col-md-6 chart-container">
                        <h4 class="text-center">Incidents by Category</h4>
                        <div id="categoryChart" style="height: 300px;"></div>
                    </div>
                </div>

                <h3 class="text-center mt-4 mb-3">Key Learnings & Advice</h3>
                <div class="alert alert-info" role="alert">
                    <strong>Remember Just Culture:</strong> This analysis aims to identify systemic patterns, not to assign individual blame. Foster an environment where errors are reported for learning, not punishment.
                </div>
                <div class="alert alert-warning" role="alert">
                    <strong>Systemic Thinking & Double-Loop Learning:</strong> If you see recurring patterns (e.g., many 'Human Error' or 'Procedure Issue' incidents), it's a signal to look beyond the immediate fix. Ask 'why?' at a deeper level to challenge underlying assumptions, training, or process design. This is Double-Loop Learning in action!
                </div>
                {% if high_severity_count > 0 %}
                <div class="alert alert-danger" role="alert">
                    <strong>Urgent Review & Learning from Worst Practice:</strong> There are {{ high_severity_count }} 'High Severity' incident(s) detected. These demand immediate, in-depth Root Cause Analysis (RCA) to uncover all contributing factors. Such events, though rare, offer profound lessons and often compel fundamental, systemic changes, just as we learn from 'worst practice' major disasters.
                </div>
                {% endif %}
            </div>
            {% endif %}
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script>
        // Plotly charts
        {% if plot_data %}
            // Plotly data is passed as entire figure JSON
            var severityFig = JSON.parse({{ plot_data.severity_data | tojson }});
            Plotly.newPlot('severityChart', severityFig.data, severityFig.layout);

            var categoryFig = JSON.parse({{ plot_data.category_data | tojson }});
            Plotly.newPlot('categoryChart', categoryFig.data, categoryFig.layout);
        {% endif %}
    </script>
</body>
</html>
